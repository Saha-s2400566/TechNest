{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - Technest{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
{% endblock %}

{% block content %}
<!-- Start Checkout Section -->
<div class="checkout-section py-5">
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="text-center mb-3">Secure Checkout</h2>
                <div class="progress mb-4" style="height: 25px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 75%;" aria-valuenow="75"
                        aria-valuemin="0" aria-valuemax="100">
                        Checkout Progress
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Billing Details -->
            <div class="col-md-7">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="card-title mb-4">Billing Details</h3>
                        <form id="billingForm" class="needs-validation" novalidate>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="firstName" class="form-label">First name *</label>
                                    <input type="text" class="form-control" id="firstName" required>
                                    <div class="invalid-feedback">
                                        Valid first name is required.
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="lastName" class="form-label">Last name *</label>
                                    <input type="text" class="form-control" id="lastName" required>
                                    <div class="invalid-feedback">
                                        Valid last name is required.
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" placeholder="you@example.com"
                                    required>
                                <div class="invalid-feedback">
                                    Please enter a valid email address.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="address" class="form-label">Address *</label>
                                <input type="text" class="form-control" id="address" required>
                                <div class="invalid-feedback">
                                    Please enter your shipping address.
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-5 mb-3">
                                    <label for="country" class="form-label">Country *</label>
                                    <select class="form-select" id="country" required>
                                        <option value="">Choose...</option>
                                        <option value="MV">Maldives</option>
                                        <option value="US">United States</option>
                                        <option value="UK">United Kingdom</option>
                                        <option value="CA">Canada</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="state" class="form-label">State/City *</label>
                                    <input type="text" class="form-control" id="state" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="zip" class="form-label">Zip *</label>
                                    <input type="text" class="form-control" id="zip" required>
                                </div>
                            </div>

                            <hr class="my-4">

                            <h4 class="mb-3">Payment Method</h4>
                            <div class="my-3">
                                <div class="form-check mb-2">
                                    <input type="radio" class="form-check-input" id="credit" name="paymentMethod"
                                        checked required>
                                    <label class="form-check-label" for="credit">
                                        <i class="fa fa-credit-card me-2"></i>Credit card
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input type="radio" class="form-check-input" id="debit" name="paymentMethod"
                                        required>
                                    <label class="form-check-label" for="debit">
                                        <i class="fa fa-credit-card me-2"></i>Debit card
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" id="paypal" name="paymentMethod"
                                        required>
                                    <label class="form-check-label" for="paypal">
                                        <i class="fa fa-paypal me-2"></i>PayPal
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="col-md-5">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="card-title mb-4">Order Summary</h3>

                        <!-- Cart Items -->
                        {% if cart_items %}
                        {% for item in cart_items %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center">
                                {% if item.product.image %}
                                <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}"
                                    style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;"
                                    class="me-3">
                                {% else %}
                                <img src="{% static 'images/no-image.png' %}" alt="{{ item.product.name }}"
                                    style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;"
                                    class="me-3">
                                {% endif %}
                                <div>
                                    <h6 class="mb-0">{{ item.product.name }}</h6>
                                    <small class="text-muted">Qty: {{ item.quantity }}</small>
                                </div>
                            </div>
                            <span class="fw-bold">${{ item.total_price }}</span>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fa fa-shopping-cart fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Your cart is empty</p>
                        </div>
                        {% endif %}

                        <hr class="my-4">

                        <!-- Totals -->
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal</span>
                            <span class="fw-bold">${{ cart_total }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping</span>
                            <span class="shipping-cost fw-bold">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax (10%)</span>
                            <span class="fw-bold">${{ tax_amount }}</span>
                        </div>
                        <hr class="my-3">
                        <div class="d-flex justify-content-between mb-4">
                            <h5>Total</h5>
                            <h5 class="total-amount">${{ total_with_tax }}</h5>
                        </div>

                        <!-- Place Order Button -->
                        {% if cart_items %}
                        <form id="placeOrderForm" action="{% url 'place_order' %}" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="shipping_method" id="shippingMethod" value="standard">
                            <input type="hidden" name="total_amount" id="totalAmount" value="{{ total_with_tax }}">
                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="fa fa-lock me-2"></i>Place Order Securely
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Shipping cost calculation
        const shippingOptions = document.querySelectorAll('input[name="shipping-option"]');
        const shippingCostDisplay = document.querySelector('.shipping-cost');
        const totalAmountDisplay = document.querySelector('.total-amount');
        const totalAmountInput = document.getElementById('totalAmount');
        const shippingMethodInput = document.getElementById('shippingMethod');

        function updateTotal() {
            const baseTotal = parseFloat('{{ cart_total }}');
            const tax = parseFloat('{{ tax_amount }}');
            const shippingMethod = document.querySelector('input[name="shipping-option"]:checked').value;
            const shippingCost = shippingMethod === 'express' ? 10 : 0;

            shippingCostDisplay.textContent = `$${shippingCost.toFixed(2)}`;
            const newTotal = baseTotal + tax + shippingCost;
            totalAmountDisplay.textContent = `$${newTotal.toFixed(2)}`;
            totalAmountInput.value = newTotal.toFixed(2);
            shippingMethodInput.value = shippingMethod;
        }

        shippingOptions.forEach(option => {
            option.addEventListener('change', updateTotal);
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        const placeOrderForm = document.getElementById('placeOrderForm');

        if (placeOrderForm) {
            placeOrderForm.addEventListener('submit', function (e) {
                e.preventDefault();

                // Submit the form data using fetch
                fetch(this.action, {
                    method: 'POST',
                    body: new FormData(this),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Show success modal
                            const successModal = new bootstrap.Modal(document.getElementById('orderSuccessModal'));
                            successModal.show();
                        } else {
                            alert('There was an error processing your order. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('There was an error processing your order. Please try again.');
                    });
            });
        }
    });
</script>
{% endblock %}